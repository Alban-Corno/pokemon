name: CI/CD
on:
  push:
    branches:
      - dev  # dÃ©clenche sur push ou merge dans dev

env:
  PROJECT_ID: pokedevops
  APP_NAME: pokemon
  REGION: europe-west9
  REGISTRY: student-alban
  CLOUDRUN_SERVICE_DEV: service-student-alban-dev

jobs:
  # ðŸ”¹ Job 1 : Build, Test, Docker Push
  build-test-push:
    runs-on: ubuntu-latest
    outputs:
      image_sha: ${{ steps.set-image.outputs.image_sha }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 18

      - name: Install dependencies
        run: npm ci --legacy-peer-deps

      # - name: Run Angular tests
      #   run: npm test -- --watch=false --browsers=ChromeHeadless

      - name: Build Angular for production
        run: npm run build -- --project=pokemon_mouille_front --configuration production

      - name: Export short SHA
        id: set-image
        run: |
          echo "IMAGE_SHA=${GITHUB_SHA::7}" >> $GITHUB_ENV
          echo "IMAGE_NAME=${REGION}-docker.pkg.dev/${PROJECT_ID}/${REGISTRY}/${APP_NAME}:${GITHUB_SHA::7}" >> $GITHUB_ENV
          echo "::set-output name=image_sha::${GITHUB_SHA::7}"

      - name: Authenticate with Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: '${{ secrets.GOOGLE_SECRET }}'

      - name: Configure Docker for GCP
        run: gcloud --quiet auth configure-docker ${REGION}-docker.pkg.dev

      - name: Build Docker image
        run: docker build -t ${IMAGE_NAME} .

      - name: Push Docker image to Registry
        run: docker push ${IMAGE_NAME}

  # ðŸ”¹ Job 2 : Deploy sur Cloud Run
  deploy:
    runs-on: ubuntu-latest
    needs: build-test-push
    steps:
      - name: Authenticate with Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: '${{ secrets.GOOGLE_SECRET }}'

      - name: Deploy Docker image to Cloud Run
        run: |
          gcloud run deploy ${CLOUDRUN_SERVICE_DEV} \
            --image=${REGION}-docker.pkg.dev/${PROJECT_ID}/${REGISTRY}/${APP_NAME}:${{ needs.build-test-push.outputs.image_sha }} \
            --project=${PROJECT_ID} \
            --region=${REGION} \
            --set-env-vars=VERSION=${{ needs.build-test-push.outputs.image_sha }} \
            --platform managed
