name: CI/CD
on:
  push:
    branches:
      - dev  # dÃ©clenche sur push ou merge dans dev

env:
  APP_NAME: ${{ vars.APP_NAME }}
  REGION: ${{ vars.ARTIFACT_LOCATION }}
  PROJECT_ID: ${{vars.GCP_PROJECT_ID}}
  REGISTRY: ${{ vars.ARTIFACT_REPO_ID }}
  CLOUDRUN_SERVICE_DEV: ${{ vars.CLOUDRUN_SERVICE_DEV }}
  
jobs:
  build-test-push-deploy:
    runs-on: ubuntu-latest
    outputs:
      image_sha: ${{ steps.set-image.outputs.image_sha }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 18

      - name: Install dependencies
        run: npm ci --legacy-peer-deps

      # - name: Run Angular tests
      #   run: npm test -- --watch=false --browsers=ChromeHeadless

      - name: Build Angular for production
        run: npm run build -- --project=pokemon_mouille_front --configuration production

      - name: Export short SHA
        id: set-image
        run: |
          echo "IMAGE_SHA=${GITHUB_SHA::7}" >> $GITHUB_ENV
          echo "IMAGE_NAME=${REGION}-docker.pkg.dev/${PROJECT_ID}/${REGISTRY}/${APP_NAME}:${GITHUB_SHA::7}" >> $GITHUB_ENV
          echo "::set-output name=image_sha::${GITHUB_SHA::7}"

      - name: Authenticate with Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: '${{ secrets.GOOGLE_SECRET }}'

      - name: Configure Docker for GCP
        run: gcloud --quiet auth configure-docker ${REGION}-docker.pkg.dev
        
      - name: Build Docker image
        run: docker build -t ${IMAGE_NAME} .

      - name: Push Docker image to Registry
        run: docker push ${IMAGE_NAME}
        
      - name: "Authenticate to Google Cloud Kubernetes Engine"
        run : gcloud container  clusters get-credentials &{KUBERNETES_CLUSTER} --region ${REGION} --project ${PROJECT_ID}

      - name: "Deploy to kuberntes"
        run: kubectl apply -f kubernetes/deploy.yaml
